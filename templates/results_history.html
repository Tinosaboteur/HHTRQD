<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AHP - L·ªãch s·ª≠ K·∫øt qu·∫£</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .history-group { margin-bottom: 30px; }
        .history-group h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .criteria-weights-list { list-style: none; padding-left: 15px; font-size: 0.9em; margin-top: 10px;}
        .criteria-weights-list li { margin-bottom: 3px; }
        .error-message { color: var(--error-color); font-weight: bold; margin-top: 10px;}
        .data-unavailable { font-style: italic; color: #888; } /* Th√™m style cho d·ªØ li·ªáu kh√¥ng c√≥ s·∫µn */
    </style>
</head>
<body>
    <h1>L·ªãch s·ª≠ K·∫øt qu·∫£ ƒê√°nh gi√° AHP (L∆∞u tr·ªØ t·ª´ Database)</h1>
     <p><small>Ch·ªâ hi·ªÉn th·ªã c√°c ph√¢n t√≠ch s·ª≠ d·ª•ng ho√†n to√†n ph∆∞∆°ng √°n v√† ti√™u ch√≠ t·ª´ c∆° s·ªü d·ªØ li·ªáu.</small></p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    {% if db_error %}
     <p class="error-message">L·ªói Database: {{ db_error }}</p>
    {% endif %}

    {% if history_list %}
        {% for history_item in history_list %}
            <div class="history-group results-section"> {# Reuse results-section style #}
                <h3>K·∫øt qu·∫£ ph√¢n t√≠ch l√∫c: {{ history_item.timestamp_str }} <small>(ID: {{ history_item.group_id[:8] }}...)</small></h3>

                <h4>X·∫øp h·∫°ng Ph∆∞∆°ng √°n:</h4>
                {% if history_item.alternatives %}
                    <table class="excel-grid small-table">
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>Ng√†nh h·ªçc (Ph∆∞∆°ng √°n)</th>
                                <th>ƒêi·ªÉm t·ªïng h·ª£p</th>
                                <th>T·ªët nh·∫•t?</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in history_item.alternatives %} {# Already sorted by score #}
                            {# Th√™m ki·ªÉm tra row l√† dictionary v√† c√≥ key c·∫ßn thi·∫øt #}
                            {% if row is mapping and 'phuong_an_ten' in row and 'final_score' in row and 'is_best' in row %}
                            <tr {% if row.is_best %}class="best-choice"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>{{ row.phuong_an_ten }}</td>
                                <td>{{ "%.5f"|format(row.final_score) }}</td>
                                <td>{% if row.is_best %}üèÜ C√≥{% else %}Kh√¥ng{% endif %}</td>
                            </tr>
                            {% else %}
                             <tr><td colspan="4" class="data-unavailable">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu ph∆∞∆°ng √°n</td></tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                     <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu ph∆∞∆°ng √°n cho l·∫ßn ph√¢n t√≠ch n√†y.</p>
                {% endif %}

                 <h4>Tr·ªçng s·ªë Ti√™u ch√≠ s·ª≠ d·ª•ng:</h4>
                 {# **** THAY ƒê·ªîI ·ªû ƒê√ÇY **** #}
                 {% if history_item.criteria %} {# Ki·ªÉm tra xem list criteria c√≥ d·ªØ li·ªáu kh√¥ng #}
                     <ul class="criteria-weights-list">
                         {% for crit_row in history_item.criteria %}
                             {# Th√™m ki·ªÉm tra crit_row l√† dictionary v√† c√≥ key c·∫ßn thi·∫øt #}
                             {% if crit_row is mapping and 'tieu_chi_ten' in crit_row and 'criterion_weight' in crit_row %}
                                 <li><strong>{{ crit_row.tieu_chi_ten }}:</strong> {{ "%.4f"|format(crit_row.criterion_weight) }}</li>
                             {% else %}
                                 <li><span class="data-unavailable">L·ªói hi·ªÉn th·ªã d·ªØ li·ªáu ti√™u ch√≠</span></li>
                             {% endif %}
                         {% endfor %}
                     </ul>
                 {% else %} {# N·∫øu history_item.criteria r·ªóng ho·∫∑c None #}
                      <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu tr·ªçng s·ªë ti√™u ch√≠ cho l·∫ßn ph√¢n t√≠ch n√†y.</p>
                 {% endif %}
                 {# **** K·∫æT TH√öC THAY ƒê·ªîI **** #}
            </div>
        {% endfor %} {# End loop history_list #}

    {% elif not db_error %}
        <p>Ch∆∞a c√≥ l·ªãch s·ª≠ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c l∆∞u trong c∆° s·ªü d·ªØ li·ªáu.</p>
    {% endif %}


    <div class="button-container">
        <a href="{{ url_for('clear_session_and_start') }}" class="btn">‚Üê B·∫Øt ƒë·∫ßu ph√¢n t√≠ch m·ªõi</a>
    </div>
</body>
</html>

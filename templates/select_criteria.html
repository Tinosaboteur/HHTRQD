<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>AHP - Bước 1: Chọn Tiêu Chí</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
   <!-- Use the same JS functions as select_alternatives -->
   <script>
    // Javascript functions (toggleCriteriaInput, addCustomInput, removeCustomInput) remain the same
    function toggleCriteriaInput(mode) {
        const dbSection = document.getElementById('db-criteria-selection');
        const customSection = document.getElementById('custom-criteria-input');
        const dbArea = document.getElementById('db-criteria-selection-area');
        const customContainer = document.getElementById('custom-criteria-container');

        dbSection.style.display = (mode === 'db') ? 'block' : 'none';
        customSection.style.display = (mode === 'custom') ? 'block' : 'none';

        // Update required status based on mode
        if (dbArea) {
            dbArea.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.required = (mode === 'db'));
        }
         // Set required only on visible inputs
        if (customContainer) {
             customContainer.querySelectorAll('input[type="text"]').forEach(inp => inp.required = (mode === 'custom'));
        }


        // Clear inputs when switching modes (optional but good practice)
        if (mode === 'db') {
            if(customContainer) customContainer.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
        } else if (mode === 'custom') {
            if(dbArea) dbArea.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = false);
        }
    }

    function addCustomInput(containerId, inputName, placeholder, minItems) {
        const container = document.getElementById(containerId);
        const newDiv = document.createElement('div');
        newDiv.className = 'custom-item'; // Use a generic class
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.name = inputName;
        newInput.placeholder = placeholder + ' ' + (container.children.length + 1);
        // Only set required if the custom section is currently visible
        newInput.required = (document.getElementById('custom-criteria-input').style.display === 'block');

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = '-';
        removeButton.className = 'btn-remove';
        removeButton.onclick = function() { removeCustomInput(this, containerId, minItems); };

        newDiv.appendChild(newInput);
        newDiv.appendChild(removeButton);
        container.appendChild(newDiv);
    }

    function removeCustomInput(button, containerId, minItems) {
        const container = document.getElementById(containerId);
        if (container.children.length > minItems) {
            button.parentElement.remove();
        } else {
            alert(`Cần ít nhất ${minItems} mục.`);
        }
    }

     document.addEventListener('DOMContentLoaded', () => {
        const initialMode = document.querySelector('input[name="mode"]:checked');
        const dbSelection = document.getElementById('db-criteria-selection');
        const customInput = document.getElementById('custom-criteria-input');
        const dbArea = document.getElementById('db-criteria-selection-area');
        const customContainer = document.getElementById('custom-criteria-container');

        if (initialMode) {
            toggleCriteriaInput(initialMode.value);
        } else {
            // Default state if nothing is checked (e.g., hide both)
            if (dbSelection) dbSelection.style.display = 'none';
            if (customInput) customInput.style.display = 'none';
             // Ensure inputs are not required initially
             if (dbArea) dbArea.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.required = false);
             if (customContainer) customContainer.querySelectorAll('input[type="text"]').forEach(inp => inp.required = false);
        }
         // Ensure initial custom fields have required=true ONLY if custom mode is selected and visible
        if (customInput && customInput.style.display === 'block' && customContainer) {
             customContainer.querySelectorAll('input[type="text"]').forEach(inp => inp.required = true);
        }
         // Ensure initial DB fields have required=true ONLY if DB mode is selected and visible
         if (dbSelection && dbSelection.style.display === 'block' && dbArea) {
              dbArea.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.required = true);
         }

         // Add form validation to check minimum checkboxes if DB mode is selected
         const form = document.querySelector('form');
         if(form){
            form.addEventListener('submit', function(event){
                const selectedMode = document.querySelector('input[name="mode"]:checked');
                if (selectedMode && selectedMode.value === 'db') {
                    const checkedBoxes = dbArea.querySelectorAll('input[type="checkbox"]:checked');
                    if (checkedBoxes.length < {{ MIN_CRITERIA }}) {
                        alert(`Vui lòng chọn ít nhất {{ MIN_CRITERIA }} tiêu chí từ cơ sở dữ liệu.`);
                        event.preventDefault(); // Stop form submission
                    }
                } else if (selectedMode && selectedMode.value === 'custom') {
                    // Basic check for at least MIN_CRITERIA non-empty custom inputs
                    const customInputs = customContainer.querySelectorAll('input[type="text"]');
                    let validCount = 0;
                    customInputs.forEach(input => {
                         if (input.value.trim() !== '') {
                            validCount++;
                         }
                    });
                    if (validCount < {{ MIN_CRITERIA }}) {
                         alert(`Vui lòng nhập ít nhất {{ MIN_CRITERIA }} tên tiêu chí tùy chỉnh hợp lệ.`);
                         event.preventDefault(); // Stop form submission
                    }
                }
            });
         }
    });
  </script>
   <style>
    /* Add styles from select_alternatives.html if not already generic in style.css */
    .mode-selection label { margin-right: 20px; cursor: pointer;}
    .mode-selection input[type="radio"] { margin-right: 5px; vertical-align: middle; }
    #db-criteria-selection, #custom-criteria-input { margin-top: 15px; padding: 15px; border: 1px dashed #ccc; border-radius: 4px; background-color: #fdfdfd;}
    .custom-item { display: flex; align-items: center; margin-bottom: 8px; }
    .custom-item input[type="text"] { flex-grow: 1; margin-right: 10px; padding: 6px 8px; border: 1px solid var(--input-border); border-radius: 3px;}
    .btn-add, .btn-remove {
        padding: 2px 8px; font-size: 16px; cursor: pointer;
        border: 1px solid #ccc; background-color: #eee; border-radius: 3px;
        line-height: 1; margin-left: 5px;
    }
    .btn-remove { background-color: #fdd; border-color: #fbb;}
    .btn-add { background-color: #dfd; border-color: #bfb;}
    .error-message { color: var(--error-color); font-weight: bold; margin-top: 10px;}
    .info-box { background-color: #e7f3fe; border-left: 5px solid #2196F3; padding: 10px 15px; margin-bottom: 20px; border-radius: 3px;}
    .info-box h4 { margin-top: 0; margin-bottom: 8px; color: #1d6aab; border-bottom: none;}
    .info-box ul { margin-top: 5px; margin-bottom: 5px; padding-left: 20px; }
    .info-box ul li { margin-bottom: 3px; list-style: disc; font-size: 0.95em; }
   </style>
</head>
<body>
  <h1>Hệ hỗ trợ ra quyết định chọn ngành học theo AHP</h1>
  <h2>Bước 1: Chọn hoặc Nhập các Tiêu chí Đánh giá</h2>
   <p>Bạn cần chọn hoặc nhập ít nhất <strong>{{ MIN_CRITERIA }}</strong> tiêu chí để thực hiện phân tích.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if db_error %}
     <p class="error-message">Lỗi Database: {{ db_error }}</p>
  {% endif %}

  {# --- Display selected alternatives --- #}
  {% if selected_alternatives %}
  <div class="info-box">
      <h4>Các phương án đang được xem xét:</h4>
      <ul>
          {% for alt in selected_alternatives %}
          {# Ensure alt is a dictionary before accessing keys #}
          {% if alt is mapping and 'ten_phuong_an' in alt %}
             <li>{{ alt.ten_phuong_an }} {% if alt.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</li>
          {% else %}
             <li><span style="color:red;">Lỗi hiển thị dữ liệu phương án</span></li>
          {% endif %}
          {% endfor %}
      </ul>
  </div>
  {% endif %}
  {# --- End display selected alternatives --- #}


  <form method="post" action="{{ url_for('select_criteria') }}">
    <p>Vui lòng chọn cách bạn muốn xác định các tiêu chí để so sánh:</p>
     <div class="mode-selection">
        <label>
            <input type="radio" name="mode" value="db" onclick="toggleCriteriaInput('db')" required> Sử dụng Database
        </label>
        <label>
            <input type="radio" name="mode" value="custom" onclick="toggleCriteriaInput('custom')" required> Nhập tùy chỉnh
        </label>
    </div>

    <!-- DB Criteria Selection -->
    <div id="db-criteria-selection" style="display: none;">
        <p>Chọn ít nhất {{ MIN_CRITERIA }} tiêu chí từ danh sách:</p>
        <div id="db-criteria-selection-area" class="criteria-selection">
          {% if all_criteria_db %}
              {% for criterion in all_criteria_db %}
              <div class="checkbox-item">
                <input type="checkbox" name="criteria_ids" value="{{ criterion.id }}" id="crit_{{ criterion.id }}">
                <label for="crit_{{ criterion.id }}">{{ criterion.ten_tieu_chi }}</label>
              </div>
              {% endfor %}
          {% elif not db_error %}
              <p>Không tìm thấy tiêu chí nào trong cơ sở dữ liệu.</p>
          {% endif %}
        </div>
         <small><i>Lưu ý: Chỉ kết quả sử dụng tiêu chí từ Database mới được lưu vào lịch sử.</i></small>
    </div>

    <!-- Custom Criteria Input -->
     <div id="custom-criteria-input" style="display: none;">
        <p>Nhập tên cho ít nhất {{ MIN_CRITERIA }} tiêu chí:</p>
        <div id="custom-criteria-container">
             <!-- Start with MIN_CRITERIA input fields -->
             {% for i in range(MIN_CRITERIA) %}
             <div class="custom-item">
                 <input type="text" name="custom_criteria_names" placeholder="Tên tiêu chí {{ i+1 }}">
                 <button type="button" onclick="removeCustomInput(this, 'custom-criteria-container', {{ MIN_CRITERIA }})" class="btn-remove" {% if loop.index <= MIN_CRITERIA %}style="visibility: hidden;"{% endif %}>-</button> {# Hide remove for first N #}
             </div>
              {% endfor %}
        </div>
        <button type="button" onclick="addCustomInput('custom-criteria-container', 'custom_criteria_names', 'Tên tiêu chí', {{ MIN_CRITERIA }})" class="btn-add">+</button> Thêm tiêu chí
         <small><i>Lưu ý: Kết quả sử dụng tiêu chí tùy chỉnh sẽ không được lưu vào lịch sử.</i></small>
    </div>

    <div class="button-container">
        <a href="{{ url_for('select_alternatives') }}" class="btn btn-secondary">← Quay lại chọn Phương án</a>
        <input type="submit" value="Tiếp tục so sánh Tiêu chí →" class="btn">
    </div>
  </form>

</body>
</html>
<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AHP - Kết quả cuối cùng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styles from previous results.html are likely fine */
        .matrix-table td, .matrix-table th { font-size: 0.9em; padding: 5px; }
        .details-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        details summary { cursor: pointer; font-weight: bold; margin-bottom: 10px; color: var(--main-color); display: list-item; }
        details summary:hover { text-decoration: underline; }
        .weight-list { list-style: none; padding-left: 0; }
        .weight-list li { margin-bottom: 4px; }
        .consistency-info { font-size: 0.9em; color: #555; margin-top: 10px; background-color: #f9f9f9; padding: 8px; border-radius: 3px; }
        .final-summary { text-align: center; font-size: 1.2em; margin-top: 25px; padding: 15px; background-color: #eafaf1; border: 1px solid #c3e6cb; border-radius: 5px; }
        .results-section ul li small { color: #888; font-style: italic; }
        .error-message { color: var(--error-color); font-weight: bold; margin: 15px; padding: 10px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;}
        .db-save-info { text-align: center; margin-top:10px; font-size: 0.9em; font-style: italic;}
    </style>
</head>
<body>
    <h1>Kết quả phân tích AHP</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}

    {# ====================== SECTION 1: SUMMARY OF CALCULATIONS ====================== #}
    {% if intermediate and not error %}
    <h2>1. Tóm tắt quá trình tính toán</h2>

    {# --- Criteria Details --- #}
    <div class="results-section details-section">
        <details>
            <summary>Chi tiết tính toán Tiêu chí (Nhấn để xem)</summary>
            <h4>Ma trận so sánh cặp Tiêu chí:</h4>
            {% if intermediate.crit_matrix and intermediate.criteria %}
            <table class="comparison-matrix excel-grid matrix-table">
                <thead>
                    <tr>
                        <th>Tiêu chí</th>
                        {% for crit in intermediate.criteria %}
                            <th>{{ crit.ten_tieu_chi }} {% if crit.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for crit_i in intermediate.criteria %} {# Outer loop #}
                    {% set i = loop.index0 %}
                    <tr>
                        <th>{{ crit_i.ten_tieu_chi }} {% if crit_i.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</th>
                        {% for crit_j in intermediate.criteria %} {# Inner loop #}
                            {% set j = loop.index0 %}
                             {# Ensure matrix has data for this cell before formatting #}
                             <td>{{ "%.3f"|format(intermediate.crit_matrix[i][j]) if intermediate.crit_matrix[i] and intermediate.crit_matrix[i][j] is not none else 'N/A' }}</td>
                        {% endfor %} {# End inner loop #}
                    </tr>
                    {% endfor %} {# End outer loop #}
                </tbody>
            </table>
            {% else %}
                <p>Không có dữ liệu ma trận tiêu chí đầy đủ.</p>
            {% endif %}

            <h4>Trọng số Tiêu chí:</h4>
             {% if intermediate.crit_weights and intermediate.criteria %}
             <ul class="weight-list">
                {% for crit in intermediate.criteria %} {# Loop for weights #}
                    <li><strong>{{ crit.ten_tieu_chi }} {% if crit.id is none %}<small>(Tùy chỉnh)</small>{% endif %}:</strong>
                        {{ "%.4f"|format(intermediate.crit_weights[loop.index0]) if intermediate.crit_weights[loop.index0] is not none else 'N/A' }}
                    </li>
                {% endfor %}
            </ul>
             {% else %}
                <p>Không có dữ liệu trọng số tiêu chí.</p>
            {% endif %}

            {% if intermediate.crit_cr is not none %}
            <div class="consistency-info">
                (λmax = {{ "%.4f"|format(intermediate.crit_lambda_max) if intermediate.crit_lambda_max is not none else 'N/A' }},
                 CI = {{ "%.4f"|format(intermediate.crit_ci) if intermediate.crit_ci is not none else 'N/A' }},
                 RI (n={{ intermediate.criteria|length }}) = {{ "%.2f"|format(intermediate.crit_ri) if intermediate.crit_ri is not none else RI_DICT.get(intermediate.criteria|length, 'N/A') }},
                 CR = <strong>{{ "%.4f"|format(intermediate.crit_cr) }}</strong>
                 {% if intermediate.crit_cr <= CR_THRESHOLD %} <span style="color:green;">(✓ Nhất quán)</span> {% else %} <span style="color:red;">(✗ Không nhất quán)</span> {% endif %})
            </div>
             {% endif %}
        </details>
    </div>

    {# --- Alternatives Details per Criterion --- #}
    <div class="results-section details-section">
         <details>
            <summary>Chi tiết tính toán Phương án theo từng Tiêu chí (Nhấn để xem)</summary>
            {% if intermediate.criteria and intermediate.alternatives and intermediate.alt_matrices_all and intermediate.alt_weights_all %}
                {% for crit in intermediate.criteria %} {# Outer loop for criteria #}
                    {% set i = loop.index0 %} {# Criterion index #}
                    <h4>Tiêu chí: {{ crit.ten_tieu_chi }} {% if crit.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</h4>
                    {# Safely access data for this criterion index #}
                    {% set alt_matrix = intermediate.alt_matrices_all[i] if i < intermediate.alt_matrices_all|length else None %}
                    {% set alt_weights = intermediate.alt_weights_all[i] if i < intermediate.alt_weights_all|length else None %}
                    {% set alt_lambda_max = intermediate.alt_lambda_max_all[i] if i < intermediate.alt_lambda_max_all|length else None %}
                    {% set alt_ci = intermediate.alt_ci_all[i] if i < intermediate.alt_ci_all|length else None %}
                    {% set alt_cr = intermediate.alt_cr_all[i] if i < intermediate.alt_cr_all|length else None %}
                    {% set alt_ri = intermediate.alt_ri_all[i] if i < intermediate.alt_ri_all|length else None %}

                    <h5>Ma trận so sánh cặp Phương án (theo Tiêu chí {{ crit.ten_tieu_chi }}):</h5>
                    {% if alt_matrix %}
                    <table class="comparison-matrix excel-grid matrix-table small-table">
                         <thead>
                            <tr>
                                <th>P.án</th>
                                {% for alt in intermediate.alternatives %}
                                    {# Use index for narrow header, add name as title #}
                                    <th title="{{ alt.ten_phuong_an }}">{{ loop.index }}</th>
                                {% endfor %}
                            </tr>
                         </thead>
                         <tbody>
                            {% for alt_j in intermediate.alternatives %} {# Inner loop for rows #}
                            {% set j = loop.index0 %}
                            <tr>
                                 {# Row header with index and name #}
                                 <th>{{ loop.index }}. {{ alt_j.ten_phuong_an }} {% if alt_j.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</th>
                                {% for alt_k in intermediate.alternatives %} {# Innermost loop for columns #}
                                    {% set k = loop.index0 %}
                                    <td>{{ "%.3f"|format(alt_matrix[j][k]) if alt_matrix[j] and alt_matrix[j][k] is not none else 'N/A' }}</td>
                                {% endfor %} {# End innermost loop #}
                            </tr>
                            {% endfor %} {# End inner loop #}
                        </tbody>
                    </table>
                    {% else %}
                        <p>Không có dữ liệu ma trận cho tiêu chí này.</p>
                    {% endif %}

                    <h5>Trọng số cục bộ (theo Tiêu chí {{ crit.ten_tieu_chi }}):</h5>
                    {% if alt_weights %}
                     <ul class="weight-list">
                         {% for alt in intermediate.alternatives %} {# Loop for weights #}
                            <li><strong>{{ loop.index }}. {{ alt.ten_phuong_an }} {% if alt.id is none %}<small>(Tùy chỉnh)</small>{% endif %}:</strong>
                                {{ "%.4f"|format(alt_weights[loop.index0]) if alt_weights[loop.index0] is not none else 'N/A' }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                       <p>Không có dữ liệu trọng số cục bộ cho tiêu chí này.</p>
                    {% endif %}

                    {% if alt_cr is not none %}
                    <div class="consistency-info">
                        (λmax = {{ "%.4f"|format(alt_lambda_max) if alt_lambda_max is not none else 'N/A' }},
                         CI = {{ "%.4f"|format(alt_ci) if alt_ci is not none else 'N/A' }},
                         RI (n={{ intermediate.alternatives|length }}) = {{ "%.2f"|format(alt_ri) if alt_ri is not none else RI_DICT.get(intermediate.alternatives|length, 'N/A') }},
                         CR = <strong>{{ "%.4f"|format(alt_cr) }}</strong>
                         {% if alt_cr <= CR_THRESHOLD %} <span style="color:green;">(✓ Nhất quán)</span> {% else %} <span style="color:red;">(✗ Không nhất quán)</span> {% endif %})
                    </div>
                    {% endif %}
                    <hr style="margin: 15px 0;">
                {% endfor %} {# End outer loop for criteria #}
            {% else %}
                 <p>Thiếu dữ liệu trung gian cần thiết cho việc hiển thị chi tiết phương án.</p>
            {% endif %}
        </details>
    </div>
    {% endif %} {# End check for intermediate data #}

    {# ====================== SECTION 2: FINAL RESULTS ====================== #}
    <h2>2. Kết quả tổng hợp và xếp hạng</h2>
    <div class="results-section">
        <h3>Điểm tổng hợp và xếp hạng các Phương án (Ngành học)</h3>
        {% if results %}
            <table class="final-results-table excel-grid">
                <thead>
                    <tr>
                        <th>Xếp hạng</th>
                        <th>Ngành học (Phương án)</th>
                        <th>Điểm tổng hợp</th>
                        <th>Lựa chọn tốt nhất?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %} {# Loop for final results #}
                    <tr {% if row.is_best %}class="best-choice"{% endif %}>
                        <td>{{ loop.index }}</td> {# Use 1-based index for rank #}
                        {# Add custom tag if ID is None #}
                        <td>{{ row.name }} {% if row.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</td>
                        <td><strong>{{ "%.5f"|format(row.score) }}</strong></td>
                        <td>{% if row.is_best %}🏆 Có{% else %}Không{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if best_alternative_info %}
            <div class="final-summary">
                Dựa trên các đánh giá của bạn, ngành học phù hợp nhất là: <br>
                <strong>{{ best_alternative_info.name }} {% if best_alternative_info.id is none %}<small>(Tùy chỉnh)</small>{% endif %}</strong>
                 ({{ "%.5f"|format(best_alternative_info.score) }} điểm)
            </div>
            {% endif %}

            {# Database Saving Info - Updated Messages #}
             <div class="db-save-info">
             {% if save_attempted %}
                {% if save_successful %}
                 <p style="color:green;">Kết quả phân tích này (sử dụng dữ liệu từ DB) đã được lưu vào lịch sử.</p>
                {% else %}
                 <p style="color:red;">Đã cố gắng lưu kết quả vào cơ sở dữ liệu nhưng không thành công.</p>
                {% endif %}
             {% elif not can_save_to_db %}
                 <p style="color:orange;">Kết quả không được lưu vào cơ sở dữ liệu vì có sử dụng phương án hoặc tiêu chí tùy chỉnh.</p>
             {% endif %}
            </div>


        {% elif not error %}
            <p>Không có kết quả cuối cùng để hiển thị (có thể do lỗi tính toán trước đó).</p>
        {% endif %} {# End check for results #}
    </div>

    <div class="button-container">
        <a href="{{ url_for('clear_session_and_start') }}" class="btn">Bắt đầu lại phân tích mới</a>
        <a href="{{ url_for('results_history') }}" class="btn btn-secondary">Xem lịch sử kết quả (DB)</a>
    </div>
</body>
</html>
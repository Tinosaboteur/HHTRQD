<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AHP - K·∫øt qu·∫£ cu·ªëi c√πng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styles from previous results.html are likely fine */
        .matrix-table td, .matrix-table th { font-size: 0.9em; padding: 5px; }
        .details-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        details summary { cursor: pointer; font-weight: bold; margin-bottom: 10px; color: var(--main-color); display: list-item; }
        details summary:hover { text-decoration: underline; }
        .weight-list { list-style: none; padding-left: 0; }
        .weight-list li { margin-bottom: 4px; }
        .consistency-info { font-size: 0.9em; color: #555; margin-top: 10px; background-color: #f9f9f9; padding: 8px; border-radius: 3px; }
        .final-summary { text-align: center; font-size: 1.2em; margin-top: 25px; padding: 15px; background-color: #eafaf1; border: 1px solid #c3e6cb; border-radius: 5px; }
        .results-section ul li small { color: #888; font-style: italic; }
        .error-message { color: var(--error-color); font-weight: bold; margin: 15px; padding: 10px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;}
        .db-save-info { text-align: center; margin-top:10px; font-size: 0.9em; font-style: italic;}
        .data-unavailable { font-style: italic; color: #888; } /* Style for missing data */
    </style>
</head>
<body>
    <h1>K·∫øt qu·∫£ ph√¢n t√≠ch AHP</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    {# Hi·ªÉn th·ªã l·ªói t√≠nh to√°n (n·∫øu c√≥) L√äN TR√äN C√ôNG #}
    {% if error %}
        <div class="error-message">L·ªói T√≠nh To√°n: {{ error }}</div>
        <p class="data-unavailable">Do l·ªói x·∫£y ra, d·ªØ li·ªáu chi ti·∫øt d∆∞·ªõi ƒë√¢y c√≥ th·ªÉ kh√¥ng ƒë·∫ßy ƒë·ªß ho·∫∑c kh√¥ng ch√≠nh x√°c.</p>
    {% endif %}

    {# ====================== SECTION 1: SUMMARY OF CALCULATIONS ====================== #}
    {# Lu√¥n c·ªë g·∫Øng hi·ªÉn th·ªã ph·∫ßn n√†y n·∫øu c√≥ 'intermediate', nh∆∞ng ki·ªÉm tra s√¢u h∆°n b√™n trong #}
    {% if intermediate %}
    <h2>1. T√≥m t·∫Øt qu√° tr√¨nh t√≠nh to√°n</h2>

    {# --- Criteria Details --- #}
    <div class="results-section details-section">
        <details {% if error %}open{% endif %}> {# M·ªü s·∫µn n·∫øu c√≥ l·ªói ƒë·ªÉ d·ªÖ debug #}
            <summary>Chi ti·∫øt t√≠nh to√°n Ti√™u ch√≠ (Nh·∫•n ƒë·ªÉ xem)</summary>
            <h4>Ma tr·∫≠n so s√°nh c·∫∑p Ti√™u ch√≠:</h4>
            {# Ki·ªÉm tra c·∫£ crit_matrix v√† selected_criteria t·ªìn t·∫°i v√† l√† list #}
            {% if intermediate.crit_matrix is iterable and intermediate.selected_criteria is iterable %}
            <table class="comparison-matrix excel-grid matrix-table">
                <thead>
                    <tr>
                        <th>Ti√™u ch√≠</th>
                        {% for crit in intermediate.selected_criteria %}
                            <th>{{ crit.ten_tieu_chi if crit is mapping else 'L·ªói T√™n' }} {% if crit is mapping and crit.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for crit_i in intermediate.selected_criteria %} {# Outer loop #}
                    {% set i = loop.index0 %}
                    <tr>
                        <th>{{ crit_i.ten_tieu_chi if crit_i is mapping else 'L·ªói T√™n' }} {% if crit_i is mapping and crit_i.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</th>
                        {# Ki·ªÉm tra h√†ng i t·ªìn t·∫°i trong ma tr·∫≠n #}
                        {% if i < intermediate.crit_matrix|length and intermediate.crit_matrix[i] is iterable %}
                            {% for crit_j in intermediate.selected_criteria %} {# Inner loop #}
                                {% set j = loop.index0 %}
                                {# Ki·ªÉm tra √¥ [i][j] t·ªìn t·∫°i v√† l√† s·ªë tr∆∞·ªõc khi format #}
                                {% if j < intermediate.crit_matrix[i]|length and intermediate.crit_matrix[i][j] is number %}
                                     <td>{{ "%.3f"|format(intermediate.crit_matrix[i][j]) }}</td>
                                {% else %}
                                     <td class="data-unavailable">N/A</td> {# D·ªØ li·ªáu √¥ kh√¥ng h·ª£p l·ªá #}
                                {% endif %}
                            {% endfor %} {# End inner loop #}
                        {% else %}
                             <td colspan="{{ intermediate.selected_criteria|length }}" class="data-unavailable">D·ªØ li·ªáu h√†ng kh√¥ng h·ª£p l·ªá</td>
                        {% endif %}
                    </tr>
                    {% endfor %} {# End outer loop #}
                </tbody>
            </table>
            {% else %}
                <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu ma tr·∫≠n ti√™u ch√≠ ƒë·∫ßy ƒë·ªß ho·∫∑c h·ª£p l·ªá.</p>
            {% endif %}

            <h4>Tr·ªçng s·ªë Ti√™u ch√≠:</h4>
             {# Ki·ªÉm tra crit_weights v√† selected_criteria t·ªìn t·∫°i, l√† list v√† c√πng ƒë·ªô d√†i #}
             {% if intermediate.crit_weights is iterable and intermediate.selected_criteria is iterable and intermediate.crit_weights|length == intermediate.selected_criteria|length %}
             <ul class="weight-list">
                {% for crit in intermediate.selected_criteria %} {# Loop for weights #}
                    {% set i = loop.index0 %}
                    <li><strong>{{ crit.ten_tieu_chi if crit is mapping else 'L·ªói T√™n' }} {% if crit is mapping and crit.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}:</strong>
                        {# Ki·ªÉm tra tr·ªçng s·ªë t·∫°i index i t·ªìn t·∫°i v√† l√† s·ªë #}
                        {% if i < intermediate.crit_weights|length and intermediate.crit_weights[i] is number %}
                             {{ "%.4f"|format(intermediate.crit_weights[i]) }}
                        {% else %}
                             <span class="data-unavailable">N/A</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
             {% else %}
                <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu tr·ªçng s·ªë ti√™u ch√≠ ho·∫∑c d·ªØ li·ªáu kh√¥ng kh·ªõp.</p>
            {% endif %}

            {# Hi·ªÉn th·ªã th√¥ng tin CR n·∫øu c√≥ #}
            {% if intermediate.crit_cr is number %}
            <div class="consistency-info">
                (Œªmax = {{ "%.4f"|format(intermediate.crit_lambda_max) if intermediate.crit_lambda_max is number else 'N/A' }},
                 CI = {{ "%.4f"|format(intermediate.crit_ci) if intermediate.crit_ci is number else 'N/A' }},
                 RI (n={{ intermediate.selected_criteria|length if intermediate.selected_criteria is iterable else '?' }}) = {{ "%.2f"|format(intermediate.crit_ri) if intermediate.crit_ri is number else RI_DICT.get(intermediate.selected_criteria|length, 'N/A') }},
                 CR = <strong>{{ "%.4f"|format(intermediate.crit_cr) }}</strong>
                 {% if intermediate.crit_cr <= CR_THRESHOLD %} <span style="color:green;">(‚úì Nh·∫•t qu√°n)</span> {% else %} <span style="color:red;">(‚úó Kh√¥ng nh·∫•t qu√°n)</span> {% endif %})
            </div>
            {% elif intermediate.crit_lambda_max is not none %} {# C√≥ th·ªÉ lambda_max c√≥ nh∆∞ng CR kh√¥ng c√≥ n·∫øu RI l·ªói #}
             <div class="consistency-info">
                 (Œªmax = {{ "%.4f"|format(intermediate.crit_lambda_max) if intermediate.crit_lambda_max is number else 'N/A' }}, CI/CR kh√¥ng c√≥)
            </div>
            {% endif %}
        </details>
    </div>

    {# --- Alternatives Details per Criterion --- #}
    <div class="results-section details-section">
         <details {% if error %}open{% endif %}> {# M·ªü s·∫µn n·∫øu c√≥ l·ªói ƒë·ªÉ d·ªÖ debug #}
            <summary>Chi ti·∫øt t√≠nh to√°n Ph∆∞∆°ng √°n theo t·ª´ng Ti√™u ch√≠ (Nh·∫•n ƒë·ªÉ xem)</summary>
            {# Ki·ªÉm tra c√°c list ch√≠nh c√≥ t·ªìn t·∫°i v√† l√† iterable #}
            {% if intermediate.selected_criteria is iterable and intermediate.session_alternatives is iterable and intermediate.alt_matrices_all is iterable and intermediate.alt_weights_all is iterable %}
                {% for crit in intermediate.selected_criteria %} {# Outer loop for criteria #}
                    {% set i = loop.index0 %} {# Criterion index #}
                    <h4>Ti√™u ch√≠: {{ crit.ten_tieu_chi if crit is mapping else 'L·ªói T√™n' }} {% if crit is mapping and crit.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</h4>

                    {# L·∫•y d·ªØ li·ªáu cho ti√™u ch√≠ n√†y, ki·ªÉm tra index tr∆∞·ªõc #}
                    {% set alt_matrix = intermediate.alt_matrices_all[i] if i < intermediate.alt_matrices_all|length else None %}
                    {% set alt_weights = intermediate.alt_weights_all[i] if i < intermediate.alt_weights_all|length else None %}
                    {% set alt_lambda_max = intermediate.alt_lambda_max_all[i] if i < intermediate.alt_lambda_max_all|length else None %}
                    {% set alt_ci = intermediate.alt_ci_all[i] if i < intermediate.alt_ci_all|length else None %}
                    {% set alt_cr = intermediate.alt_cr_all[i] if i < intermediate.alt_cr_all|length else None %}
                    {% set alt_ri = intermediate.alt_ri_all[i] if i < intermediate.alt_ri_all|length else None %}

                    <h5>Ma tr·∫≠n so s√°nh c·∫∑p Ph∆∞∆°ng √°n (theo Ti√™u ch√≠ {{ crit.ten_tieu_chi if crit is mapping else 'L·ªói T√™n' }}):</h5>
                    {# Ki·ªÉm tra ma tr·∫≠n ph·ª• c√≥ t·ªìn t·∫°i v√† l√† list #}
                    {% if alt_matrix is iterable %}
                    <table class="comparison-matrix excel-grid matrix-table small-table">
                         <thead>
                            <tr>
                                <th>P.√°n</th>
                                {% for alt in intermediate.session_alternatives %}
                                    {# Use index for narrow header, add name as title #}
                                    <th title="{{ alt.ten_phuong_an if alt is mapping else 'L·ªói T√™n' }}">{{ loop.index }}</th>
                                {% endfor %}
                            </tr>
                         </thead>
                         <tbody>
                            {% for alt_j in intermediate.session_alternatives %} {# Inner loop for rows #}
                            {% set j = loop.index0 %}
                            <tr>
                                 {# Row header with index and name #}
                                 <th>{{ loop.index }}. {{ alt_j.ten_phuong_an if alt_j is mapping else 'L·ªói T√™n' }} {% if alt_j is mapping and alt_j.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</th>
                                 {# Ki·ªÉm tra h√†ng j trong ma tr·∫≠n ph·ª• c√≥ t·ªìn t·∫°i v√† l√† list #}
                                 {% if j < alt_matrix|length and alt_matrix[j] is iterable %}
                                    {% for alt_k in intermediate.session_alternatives %} {# Innermost loop for columns #}
                                        {% set k = loop.index0 %}
                                        {# Ki·ªÉm tra √¥ [j][k] t·ªìn t·∫°i v√† l√† s·ªë #}
                                        {% if k < alt_matrix[j]|length and alt_matrix[j][k] is number %}
                                             <td>{{ "%.3f"|format(alt_matrix[j][k]) }}</td>
                                        {% else %}
                                             <td class="data-unavailable">N/A</td>
                                        {% endif %}
                                    {% endfor %} {# End innermost loop #}
                                {% else %}
                                     <td colspan="{{ intermediate.session_alternatives|length }}" class="data-unavailable">D·ªØ li·ªáu h√†ng kh√¥ng h·ª£p l·ªá</td>
                                {% endif %}
                            </tr>
                            {% endfor %} {# End inner loop #}
                        </tbody>
                    </table>
                    {% else %}
                        <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu ma tr·∫≠n cho ti√™u ch√≠ n√†y.</p>
                    {% endif %}

                    <h5>Tr·ªçng s·ªë c·ª•c b·ªô (theo Ti√™u ch√≠ {{ crit.ten_tieu_chi if crit is mapping else 'L·ªói T√™n' }}):</h5>
                     {# Ki·ªÉm tra list tr·ªçng s·ªë ph·ª• c√≥ t·ªìn t·∫°i, l√† list v√† kh·ªõp s·ªë l∆∞·ª£ng ph∆∞∆°ng √°n #}
                    {% if alt_weights is iterable and alt_weights|length == intermediate.session_alternatives|length %}
                     <ul class="weight-list">
                         {% for alt in intermediate.session_alternatives %} {# Loop for weights #}
                            {% set j = loop.index0 %}
                            <li><strong>{{ loop.index }}. {{ alt.ten_phuong_an if alt is mapping else 'L·ªói T√™n' }} {% if alt is mapping and alt.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}:</strong>
                                {# Ki·ªÉm tra tr·ªçng s·ªë t·∫°i index j t·ªìn t·∫°i v√† l√† s·ªë #}
                                {% if j < alt_weights|length and alt_weights[j] is number %}
                                    {{ "%.4f"|format(alt_weights[j]) }}
                                {% else %}
                                    <span class="data-unavailable">N/A</span>
                                {% endif %}
                             </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                       <p class="data-unavailable">Kh√¥ng c√≥ d·ªØ li·ªáu tr·ªçng s·ªë c·ª•c b·ªô ho·∫∑c d·ªØ li·ªáu kh√¥ng kh·ªõp.</p>
                    {% endif %}

                    {# Hi·ªÉn th·ªã CR n·∫øu c√≥ #}
                    {% if alt_cr is number %}
                    <div class="consistency-info">
                        (Œªmax = {{ "%.4f"|format(alt_lambda_max) if alt_lambda_max is number else 'N/A' }},
                         CI = {{ "%.4f"|format(alt_ci) if alt_ci is number else 'N/A' }},
                         RI (n={{ intermediate.session_alternatives|length if intermediate.session_alternatives is iterable else '?'}}) = {{ "%.2f"|format(alt_ri) if alt_ri is number else RI_DICT.get(intermediate.session_alternatives|length, 'N/A') }},
                         CR = <strong>{{ "%.4f"|format(alt_cr) }}</strong>
                         {% if alt_cr <= CR_THRESHOLD %} <span style="color:green;">(‚úì Nh·∫•t qu√°n)</span> {% else %} <span style="color:red;">(‚úó Kh√¥ng nh·∫•t qu√°n)</span> {% endif %})
                    </div>
                     {% elif alt_lambda_max is not none %} {# C√≥ th·ªÉ lambda_max c√≥ nh∆∞ng CR kh√¥ng c√≥ n·∫øu RI l·ªói #}
                     <div class="consistency-info">
                         (Œªmax = {{ "%.4f"|format(alt_lambda_max) if alt_lambda_max is number else 'N/A' }}, CI/CR kh√¥ng c√≥)
                     </div>
                    {% endif %}
                    <hr style="margin: 15px 0;"> {# Separator between criteria #}
                {% endfor %} {# End outer loop for criteria #}
            {% else %}
                 <p class="data-unavailable">Thi·∫øu d·ªØ li·ªáu trung gian c·∫ßn thi·∫øt cho vi·ªác hi·ªÉn th·ªã chi ti·∫øt ph∆∞∆°ng √°n.</p>
            {% endif %}
        </details>
    </div>
    {% endif %} {# End check for intermediate data #}

    {# ====================== SECTION 2: FINAL RESULTS ====================== #}
    {# Ch·ªâ hi·ªÉn th·ªã ph·∫ßn n√†y n·∫øu KH√îNG C√ì L·ªñI v√† C√ì K·∫æT QU·∫¢ CU·ªêI C√ôNG ('results') #}
    {% if not error and results %}
    <h2>2. K·∫øt qu·∫£ t·ªïng h·ª£p v√† x·∫øp h·∫°ng</h2>
    <div class="results-section">
        <h3>ƒêi·ªÉm t·ªïng h·ª£p v√† x·∫øp h·∫°ng c√°c Ph∆∞∆°ng √°n (Ng√†nh h·ªçc)</h3>
            <table class="final-results-table excel-grid">
                <thead>
                    <tr>
                        <th>X·∫øp h·∫°ng</th>
                        <th>Ng√†nh h·ªçc (Ph∆∞∆°ng √°n)</th>
                        <th>ƒêi·ªÉm t·ªïng h·ª£p</th>
                        <th>L·ª±a ch·ªçn t·ªët nh·∫•t?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %} {# Loop for final results #}
                    {# Ki·ªÉm tra row c√≥ ph·∫£i dictionary v√† c√≥ c√°c key c·∫ßn thi·∫øt #}
                    {% if row is mapping and 'name' in row and 'score' in row and 'is_best' in row %}
                        <tr {% if row.is_best %}class="best-choice"{% endif %}>
                            <td>{{ loop.index }}</td> {# Use 1-based index for rank #}
                            {# Add custom tag if ID is None #}
                            <td>{{ row.name }} {% if row.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</td>
                            <td><strong>{{ "%.5f"|format(row.score) }}</strong></td>
                            <td>{% if row.is_best %}üèÜ C√≥{% else %}Kh√¥ng{% endif %}</td>
                        </tr>
                    {% else %}
                        <tr><td colspan="4" class="data-unavailable">L·ªói hi·ªÉn th·ªã d√≤ng k·∫øt qu·∫£</td></tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            {# Hi·ªÉn th·ªã ph∆∞∆°ng √°n t·ªët nh·∫•t n·∫øu c√≥ #}
            {% if best_alternative_info is mapping and 'name' in best_alternative_info and 'score' in best_alternative_info %}
            <div class="final-summary">
                D·ª±a tr√™n c√°c ƒë√°nh gi√° c·ªßa b·∫°n, ng√†nh h·ªçc ph√π h·ª£p nh·∫•t l√†: <br>
                <strong>{{ best_alternative_info.name }} {% if best_alternative_info.id is none %}<small>(T√πy ch·ªânh)</small>{% endif %}</strong>
                 ({{ "%.5f"|format(best_alternative_info.score) }} ƒëi·ªÉm)
            </div>
            {% endif %}

            {# Database Saving Info - Updated Messages #}
             <div class="db-save-info">
             {% if save_attempted %}
                {% if save_successful %}
                 <p style="color:green;">K·∫øt qu·∫£ ph√¢n t√≠ch n√†y (s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ DB) ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.</p>
                {% else %}
                 <p style="color:red;">ƒê√£ c·ªë g·∫Øng l∆∞u k·∫øt qu·∫£ v√†o c∆° s·ªü d·ªØ li·ªáu nh∆∞ng kh√¥ng th√†nh c√¥ng.</p>
                {% endif %}
             {% elif not can_save_to_db %}
                 <p style="color:orange;">K·∫øt qu·∫£ kh√¥ng ƒë∆∞·ª£c l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu v√¨ c√≥ s·ª≠ d·ª•ng ph∆∞∆°ng √°n ho·∫∑c ti√™u ch√≠ t√πy ch·ªânh.</p>
             {% endif %}
            </div>


    </div>
    {% elif not error %} {# N·∫øu kh√¥ng c√≥ l·ªói nh∆∞ng c≈©ng kh√¥ng c√≥ results #}
         <h2>2. K·∫øt qu·∫£ t·ªïng h·ª£p v√† x·∫øp h·∫°ng</h2>
         <p class="data-unavailable">Kh√¥ng c√≥ k·∫øt qu·∫£ cu·ªëi c√πng ƒë·ªÉ hi·ªÉn th·ªã (c√≥ th·ªÉ do kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu h·ª£p l·ªá t·ª´ c√°c b∆∞·ªõc tr∆∞·ªõc).</p>
    {% endif %} {# End check for final results section #}

    <div class="button-container">
        <a href="{{ url_for('clear_session_and_start') }}" class="btn">B·∫Øt ƒë·∫ßu l·∫°i ph√¢n t√≠ch m·ªõi</a>
        <a href="{{ url_for('results_history') }}" class="btn btn-secondary">Xem l·ªãch s·ª≠ k·∫øt qu·∫£ (DB)</a>
    </div>
</body>
</html>
